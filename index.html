<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soulsborne 3D - Open World Action RPG</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <!-- HUD -->
        <div id="hud">
            <div id="player-stats">
                <div class="stat-bar-container">
                    <div id="health-bar" class="stat-bar">
                        <div id="health-fill" class="stat-fill health"></div>
                        <span id="health-text" class="stat-text">100/100</span>
                    </div>
                </div>
                <div class="stat-bar-container">
                    <div id="stamina-bar" class="stat-bar">
                        <div id="stamina-fill" class="stat-fill stamina"></div>
                    </div>
                </div>
                <div class="stat-bar-container">
                    <div id="mana-bar" class="stat-bar">
                        <div id="mana-fill" class="stat-fill mana"></div>
                    </div>
                </div>
            </div>
            
            <div id="souls-counter">
                <span id="souls-icon">‚óá</span>
                <span id="souls-amount">0</span>
            </div>
            
            <div id="equipment-display">
                <div class="equipment-slot" id="weapon-slot">‚öî</div>
                <div class="equipment-slot" id="shield-slot">üõ°</div>
                <div class="equipment-slot" id="item-slot">üß™</div>
            </div>
            
            <!-- Minimap -->
            <div id="minimap-container">
                <canvas id="minimap" width="150" height="150"></canvas>
            </div>
        </div>
        
        <!-- Boss Health Bar -->
        <div id="boss-health-container" class="hidden">
            <div id="boss-name">Boss Name</div>
            <div id="boss-health-bar">
                <div id="boss-health-fill"></div>
            </div>
        </div>
        
        <!-- Lock-on Indicator -->
        <div id="lock-on-indicator" class="hidden">‚óé</div>
        
        <!-- Death Screen -->
        <div id="death-screen" class="hidden">
            <div id="death-text">YOU DIED</div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="hidden">
            <div id="victory-text">ENEMY FELLED</div>
            <div id="souls-gained"></div>
        </div>
        
        <!-- Pause Menu -->
        <div id="pause-menu" class="hidden">
            <div class="menu-container">
                <h1>PAUSED</h1>
                <button class="menu-button" id="resume-btn">Resume</button>
                <button class="menu-button" id="inventory-btn">Inventory</button>
                <button class="menu-button" id="equipment-btn">Equipment</button>
                <button class="menu-button" id="stats-btn">Character</button>
                <button class="menu-button" id="map-btn">Map</button>
                <button class="menu-button" id="quit-btn">Quit</button>
            </div>
        </div>
        
        <!-- Bonfire/Checkpoint Menu -->
        <div id="bonfire-menu" class="hidden">
            <div class="menu-container">
                <h1>SITE OF GRACE</h1>
                <button class="menu-button" id="rest-btn">Rest</button>
                <button class="menu-button" id="level-up-btn">Level Up</button>
                <button class="menu-button" id="fast-travel-btn">Fast Travel</button>
                <button class="menu-button" id="leave-btn">Leave</button>
            </div>
        </div>
        
        <!-- Level Up Menu -->
        <div id="level-up-menu" class="hidden">
            <div class="menu-container level-up">
                <h1>LEVEL UP</h1>
                <div id="current-level">Level: <span id="level-value">1</span></div>
                <div id="souls-available">Souls: <span id="souls-for-level">0</span></div>
                <div id="cost-display">Cost: <span id="level-cost">100</span></div>
                <div class="stats-grid">
                    <div class="stat-row">
                        <span class="stat-name">Vigor</span>
                        <span class="stat-value" id="vigor-value">10</span>
                        <button class="stat-btn" data-stat="vigor">+</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">Endurance</span>
                        <span class="stat-value" id="endurance-value">10</span>
                        <button class="stat-btn" data-stat="endurance">+</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">Strength</span>
                        <span class="stat-value" id="strength-value">10</span>
                        <button class="stat-btn" data-stat="strength">+</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">Dexterity</span>
                        <span class="stat-value" id="dexterity-value">10</span>
                        <button class="stat-btn" data-stat="dexterity">+</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">Intelligence</span>
                        <span class="stat-value" id="intelligence-value">10</span>
                        <button class="stat-btn" data-stat="intelligence">+</button>
                    </div>
                    <div class="stat-row">
                        <span class="stat-name">Faith</span>
                        <span class="stat-value" id="faith-value">10</span>
                        <button class="stat-btn" data-stat="faith">+</button>
                    </div>
                </div>
                <button class="menu-button" id="confirm-level-btn">Confirm</button>
                <button class="menu-button" id="cancel-level-btn">Back</button>
            </div>
        </div>
        
        <!-- Shop Menu -->
        <div id="shop-menu" class="hidden">
            <div class="menu-container shop-container">
                <h1 id="shop-title">MERCHANT</h1>
                <div id="shop-souls">Souls: <span id="shop-souls-amount">0</span></div>
                <div id="shop-items-grid" class="shop-items-grid">
                    <!-- Shop items will be populated here -->
                </div>
                <button class="menu-button" id="close-shop-btn">Leave</button>
            </div>
        </div>
        
        <!-- Fast Travel Map -->
        <div id="fast-travel-menu" class="hidden">
            <div class="menu-container map-container">
                <h1>FAST TRAVEL</h1>
                <div id="map-canvas-container">
                    <canvas id="map-canvas" width="800" height="600"></canvas>
                </div>
                <div id="map-legend">
                    <div><span class="legend-icon" style="color: #ffd700;">‚óè</span> Site of Grace</div>
                    <div><span class="legend-icon" style="color: #00ff00;">‚ñ≤</span> Your Location</div>
                </div>
                <p id="map-hint">Click on a Site of Grace to travel (only from a Site of Grace)</p>
                <button class="menu-button" id="close-map-btn">Close Map</button>
            </div>
        </div>
        
        <!-- Interaction Prompt -->
        <div id="interaction-prompt" class="hidden">
            <span id="prompt-key">E</span>
            <span id="prompt-text">Interact</span>
        </div>
        
        <!-- Debug Info -->
        <div id="debug-info" class="hidden">
            <div id="fps">FPS: 0</div>
            <div id="position">Pos: 0, 0, 0</div>
            <div id="state">State: idle</div>
        </div>
        
        <!-- Controls Help -->
        <div id="controls-help">
            <div class="control-item">WASD - Move</div>
            <div class="control-item">Mouse - Look</div>
            <div class="control-item">Space - Roll</div>
            <div class="control-item">Click - Attack</div>
            <div class="control-item">Shift - Sprint</div>
            <div class="control-item">Tab - Lock-on</div>
            <div class="control-item">Q - Cast Spell</div>
            <div class="control-item">F - Heal</div>
            <div class="control-item">R - Use Item</div>
            <div class="control-item">L - Weapon Art</div>
            <div class="control-item">X - Cycle Weapon</div>
            <div class="control-item">I - Inventory</div>
            <div class="control-item">M - Fast Travel Map</div>
            <div class="control-item">1/2/3 - Select Spell</div>
            <div class="control-item">G - Settings</div>
        </div>
        
        <!-- Status Bar -->
        <div id="status-bar"></div>
        
        <!-- Time Indicator -->
        <div id="time-indicator"></div>
    </div>
    
    <!-- Import Map for ES Modules - Uses local Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "/lib/three/build/three.module.js",
                "three/addons/": "/lib/three/examples/jsm/"
            }
        }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[SW] Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('[SW] Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    
    <!-- Runtime Checks Enabler -->
    <script>
        // Enable runtime checks by default (can be disabled via localStorage)
        if (!localStorage.getItem('enableRuntimeChecks')) {
            localStorage.setItem('enableRuntimeChecks', 'true');
        }
        
        // Helper functions for toggling settings via browser console
        window.toggleRuntimeChecks = () => {
            const current = localStorage.getItem('enableRuntimeChecks') === 'true';
            localStorage.setItem('enableRuntimeChecks', (!current).toString());
            console.log(`Runtime checks ${!current ? 'enabled' : 'disabled'}. Reload page for changes to take effect.`);
        };
        
        window.toggleForcePotato = () => {
            const current = localStorage.getItem('forcePotato') === 'true';
            localStorage.setItem('forcePotato', (!current).toString());
            console.log(`Force potato mode ${!current ? 'enabled' : 'disabled'}. Reload page for changes to take effect.`);
        };
        
        // Log current settings
        console.log('[Settings] Runtime checks:', localStorage.getItem('enableRuntimeChecks'));
        console.log('[Settings] Force potato:', localStorage.getItem('forcePotato'));
        console.log('[Settings] Use toggleRuntimeChecks() or toggleForcePotato() to change');
    </script>
    
    <!-- Three.js Detection Script -->
    <script>
        // Check if Three.js is available immediately when page loads
        (async function checkThreeJS() {
            try {
                // Add timeout to prevent indefinite hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/lib/three/build/three.module.js', { 
                    method: 'HEAD',
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error('Three.js not found');
                }
            } catch (error) {
                console.error('[Setup Error] Three.js library not found!');
                console.error('[Setup Error] This causes the black screen with only UI visible.');
                console.error('[Setup Error] Please run: npm install && npm run setup');
                console.error('[Setup Error] See README.md for detailed setup instructions.');
                
                // Show error overlay immediately
                function showSetupError() {
                    // Prevent duplicate overlays
                    if (document.getElementById('setup-error-overlay')) {
                        return;
                    }
                    
                    const overlay = document.createElement('div');
                    overlay.id = 'setup-error-overlay';
                    overlay.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.95);
                        color: #ff6b6b;
                        padding: 30px;
                        border: 3px solid #ff6b6b;
                        border-radius: 10px;
                        font-family: monospace;
                        font-size: 14px;
                        z-index: 10000;
                        max-width: 600px;
                        text-align: left;
                    `;
                    overlay.innerHTML = `
                        <h2 style="margin-top: 0; color: #ff6b6b;">‚ö†Ô∏è Setup Required</h2>
                        <p><strong>Three.js library not found!</strong></p>
                        <p>This causes the black screen with only UI visible.</p>
                        <h3 style="color: #ffd93d;">Quick Fix:</h3>
                        <pre style="background: #1a1a1a; padding: 10px; border-radius: 5px; overflow-x: auto;">npm install
npm run setup
npm run build
npm run serve</pre>
                        <p><strong>Why?</strong> The game requires Three.js which is not included in the repository to keep it lightweight. You must download it using the setup script.</p>
                        <p style="font-size: 12px; color: #888;">See <strong>README.md</strong> for detailed instructions.</p>
                        <button id="close-setup-error" style="
                            background: #ff6b6b;
                            border: none;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-family: monospace;
                            margin-top: 10px;
                        ">Close</button>
                    `;
                    document.body.appendChild(overlay);
                    
                    // Add event listener for close button (CSP-compliant)
                    document.getElementById('close-setup-error').addEventListener('click', () => {
                        overlay.remove();
                    });
                }
                
                // Show error immediately if DOM is ready, otherwise wait
                if (document.body) {
                    showSetupError();
                } else {
                    document.addEventListener('DOMContentLoaded', showSetupError);
                }
            }
        })();
    </script>
    
    <!-- Main Application - Use bundle.js in production, js/main.js in development -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
